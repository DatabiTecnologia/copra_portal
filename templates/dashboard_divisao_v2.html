{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm p-4">
    <h2 class="mb-3 text-primary">üìä Dashboard por Divis√£o (v2)</h2>

    <form method="POST" class="row g-3 align-items-end mb-3">
      <div class="col-md-6">
        <label class="form-label">Selecione a divis√£o:</label>
        <select name="divisao" class="form-select" required>
          <option value="">-- Escolha --</option>
          {% for d in divisoes %}
            <option value="{{ d }}" {% if d == divisao_selecionada %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Carregar</button>
      </div>
    </form>

    {% if mensagem %}
      <div class="alert alert-warning">{{ mensagem }}</div>
    {% endif %}

    {% if divisao_selecionada %}
      <hr>
      <h5 class="text-secondary mb-3">Divis√£o: <b>{{ divisao_selecionada }}</b></h5>

      <!-- Cards -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
              <div class="text-muted">Total</div>
              <h3>{{ cards.total_registros }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
              <div class="text-muted">Localizados</div>
              <h3 class="text-success">{{ cards.total_localizados }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
              <div class="text-muted">N√£o localizados</div>
              <h3 class="text-danger">{{ cards.total_nao_localizados }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center border-0 shadow-sm">
            <div class="card-body">
              <div class="text-muted">% N√£o localizado</div>
              <h3 class="text-warning">{{ cards.percent_nao_localizados }}%</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fico 1: inserido_em -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">üìå Localizados vs N√£o localizados (por inser√ß√£o - √∫ltimos 12 meses)</h5>
          <canvas id="chartInserido" height="90"></canvas>
        </div>
      </div>

      <!-- Gr√°fico 2: tentativas -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">üßæ Tentativas por dia (total vs encontrados - √∫ltimos 12 meses)</h5>
          <canvas id="chartTentativas" height="90"></canvas>
        </div>
      </div>

      <!-- Gr√°fico 3: achados -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">‚úÖ Achados por data da localiza√ß√£o (√∫ltimos 12 meses)</h5>
          <canvas id="chartAchados" height="90"></canvas>
        </div>
      </div>

      <!-- Tabela achados -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">üìã Itens achados (√∫ltimos 12 meses)</h5>

          <div class="table-responsive" style="max-height: 65vh; overflow:auto;">
            <table class="table table-sm table-striped table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>C√≥digo</th>
                  <th>T√≠tulo</th>
                  <th>Nota√ß√£o</th>
                  <th>Localiza√ß√£o</th>
                  <th>Data Documento</th>
                  <th>Data Localiza√ß√£o</th>
                  <th>Divis√£o</th>
                  <th>Inserido por</th>
                  <th>Inserido em</th>
                  <th>Alterado por</th>
                  <th>Alterado em</th>
                </tr>
              </thead>
              <tbody>
                {% for r in achados_mes %}
                    <tr>
                    <td><a href="{{ url_for('editar_registro', id=r[0]) }}">{{ r[0] }}</a></td>
                    <td>{{ r[3] or '' }}</td>  {# C√≥digo #}
                    <td>{{ r[2] or '' }}</td>  {# T√≠tulo #}
                    <td>{{ r[4] or '' }}</td>  {# Nota√ß√£o #}
                    <td>{{ r[5] or '' }}</td>  {# Localiza√ß√£o f√≠sica #}

                    {# Data Documento (data_registro - r[6]) #}
                    <td>
                        {% if r[6] %}
                        {{ r[6].strftime('%d/%m/%Y') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    {# Data Localiza√ß√£o (data_localizacao - r[7]) #}
                    <td>
                        {% if r[7] %}
                        {{ r[7].strftime('%d/%m/%Y') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td>{{ r[9] or '' }}</td>   {# Divis√£o #}
                    <td>{{ r[11] or '' }}</td>  {# Inserido por #}

                    {# Inserido em (timestamp - r[12]) #}
                    <td>
                        {% if r[12] %}
                        {{ r[12].strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>

                    <td>{{ r[13] or '' }}</td>  {# Alterado por #}

                    {# Alterado em (timestamp - r[14]) #}
                    <td>
                        {% if r[14] %}
                        {{ r[14].strftime('%d/%m/%Y %H:%M') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    </tr>
                {% endfor %}
                </tbody>

            </table>
          </div>

          {% if not achados_mes or achados_mes|length == 0 %}
            <div class="alert alert-secondary mb-0">Nenhum item localizado no per√≠odo.</div>
          {% endif %}
        </div>
      </div>

    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // 1) Inserido_em
  const ctx1 = document.getElementById('chartInserido');
  if (ctx1) {
    new Chart(ctx1, {
      type: 'line',
      data: {
        labels: {{ labels_inserido|tojson }},
        datasets: [
          { label: 'Localizados', data: {{ serie_localizados_inserido|tojson }}, tension: 0.25 },
          { label: 'N√£o localizados', data: {{ serie_nao_localizados_inserido|tojson }}, tension: 0.25 }
        ]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  }

  // 2) Tentativas
  const ctx2 = document.getElementById('chartTentativas');
  if (ctx2) {
    new Chart(ctx2, {
      type: 'line',
      data: {
        labels: {{ labels_tentativas|tojson }},
        datasets: [
          { label: 'Tentativas (total)', data: {{ serie_tentativas_total|tojson }}, tension: 0.25 },
          { label: 'Encontrados (tentativas)', data: {{ serie_tentativas_encontrado|tojson }}, tension: 0.25 }
        ]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  }

  // 3) Achados por data_localizacao
  const ctx3 = document.getElementById('chartAchados');
  if (ctx3) {
    new Chart(ctx3, {
      type: 'line',
      data: {
        labels: {{ labels_achados|tojson }},
        datasets: [
          { label: 'Achados', data: {{ serie_achados|tojson }}, tension: 0.25 }
        ]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  }
</script>
{% endblock %}
