{% extends "base.html" %}
{% block title %}Verificar C√≥digo / Nota√ß√£o{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">üîé Verificar Registro</h4>
    </div>

    <div class="card-body">
      <form method="POST" class="row g-3 align-items-end" autocomplete="off">
        <!-- C√ìDIGO DE REFER√äNCIA -->
        <div class="col-md-5 position-relative">
          <label class="form-label fw-semibold">C√≥digo de Refer√™ncia</label>
          <input
            type="text"
            id="codigo_referencia"
            name="codigo_referencia"
            class="form-control"
            placeholder="Ex: BR_RJANRIO_R0_TESTE001"
            value="{{ codigo or '' }}"
            autocomplete="off"
          >
          <div class="form-text">Busca n√£o diferencia mai√∫sculas/min√∫sculas.</div>

          <!-- Sugest√µes de c√≥digo -->
          <div id="codigoSuggestions"
               class="list-group position-absolute w-100"
               style="z-index: 1050; max-height: 250px; overflow-y: auto; display:none;">
          </div>
        </div>

        <!-- NOTA√á√ÉO -->
        <div class="col-md-5 position-relative">
          <label class="form-label fw-semibold">Nota√ß√£o</label>
          <input
            type="text"
            id="notacao"
            name="notacao"
            class="form-control"
            placeholder="Ex: Livro 2-A"
            value="{{ notacao or '' }}"
            autocomplete="off"
          >
          <div class="form-text">Pode preencher C√≥digo OU Nota√ß√£o.</div>

          <!-- Sugest√µes de nota√ß√£o -->
          <div id="notacaoSuggestions"
               class="list-group position-absolute w-100"
               style="z-index: 1050; max-height: 250px; overflow-y: auto; display:none;">
          </div>
        </div>

        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">
            üîç Buscar
          </button>
        </div>
      </form>

      <hr class="my-4">

      {% if registro %}
        <div class="alert alert-success">
          ‚úÖ Registro encontrado! Voc√™ pode editar.
        </div>

        <a href="{{ url_for('editar_registro', id=registro.id) }}" class="btn btn-outline-warning">
          ‚úèÔ∏è Editar registro #{{ registro.id }}
        </a>
      {% endif %}

      {% if nao_encontrado %}
        <div class="alert alert-warning mt-3">
          Nenhum registro encontrado.
        </div>

        {% if tipo_busca == 'codigo' %}
          <a class="btn btn-primary"
             href="{{ url_for('inserir_dados') }}?codigo={{ (codigo or '')|urlencode }}">
            ‚ûï Inserir novo com esse c√≥digo
          </a>
        {% elif tipo_busca == 'notacao' %}
          <a class="btn btn-primary"
             href="{{ url_for('inserir_dados') }}?notacao={{ (notacao or '')|urlencode }}">
            ‚ûï Inserir novo com essa nota√ß√£o
          </a>
        {% endif %}
      {% endif %}

      <div class="d-flex gap-2 mt-4">
        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
          ‚¨ÖÔ∏è Voltar para Home
        </a>
        <a href="{{ url_for('pesquisar_divisao') }}" class="btn btn-outline-primary">
          üìÅ Pesquisar por Divis√£o
        </a>
      </div>
    </div>
  </div>
</div>

<!-- üîΩ Script de autocomplete -->
<script>
(function () {
  // Helper para debouce (evitar flood no servidor)
  function debounce(fn, delay) {
    let timer = null;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // ====== AUTOCOMPLETE C√ìDIGO ======
  const codigoInput = document.getElementById('codigo_referencia');
  const codigoBox   = document.getElementById('codigoSuggestions');

  async function fetchCodigo(term) {
    if (!term || term.length < 2) {
      codigoBox.style.display = 'none';
      codigoBox.innerHTML = '';
      return;
    }
    try {
      const resp = await fetch(`/autocomplete/codigo?q=${encodeURIComponent(term)}`);
      if (!resp.ok) return;
      const data = await resp.json(); // espera lista de strings
      renderSuggestions(codigoBox, data, valor => {
        codigoInput.value = valor;
        codigoBox.style.display = 'none';
      });
    } catch (e) {
      console.error('Erro autocomplete c√≥digo:', e);
    }
  }

  // ====== AUTOCOMPLETE NOTA√á√ÉO ======
  const notacaoInput = document.getElementById('notacao');
  const notacaoBox   = document.getElementById('notacaoSuggestions');

  async function fetchNotacao(term) {
    if (!term || term.length < 2) {
      notacaoBox.style.display = 'none';
      notacaoBox.innerHTML = '';
      return;
    }
    try {
      const resp = await fetch(`/autocomplete/notacao?q=${encodeURIComponent(term)}`);
      if (!resp.ok) return;
      const data = await resp.json(); // lista de strings
      renderSuggestions(notacaoBox, data, valor => {
        notacaoInput.value = valor;
        notacaoBox.style.display = 'none';
      });
    } catch (e) {
      console.error('Erro autocomplete nota√ß√£o:', e);
    }
  }

  const debouncedCodigo  = debounce(e => fetchCodigo(e.target.value), 250);
  const debouncedNotacao = debounce(e => fetchNotacao(e.target.value), 250);

  if (codigoInput) {
    codigoInput.addEventListener('input', debouncedCodigo);
    codigoInput.addEventListener('blur', () => {
      setTimeout(() => { codigoBox.style.display = 'none'; }, 150);
    });
  }

  if (notacaoInput) {
    notacaoInput.addEventListener('input', debouncedNotacao);
    notacaoInput.addEventListener('blur', () => {
      setTimeout(() => { notacaoBox.style.display = 'none'; }, 150);
    });
  }

  // Render gen√©rico de sugest√µes
  function renderSuggestions(container, items, onClickItem) {
    container.innerHTML = '';
    if (!items || !items.length) {
      container.style.display = 'none';
      return;
    }
    items.forEach(texto => {
      const a = document.createElement('button');
      a.type = 'button';
      a.className = 'list-group-item list-group-item-action';
      a.textContent = texto;
      a.onclick = () => onClickItem(texto);
      container.appendChild(a);
    });
    container.style.display = 'block';
  }

})();
</script>
{% endblock %}
