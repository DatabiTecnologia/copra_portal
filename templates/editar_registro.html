{% extends "base.html" %}
{% block title %}Editar Registro{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">‚úèÔ∏è Editar Registro #{{ registro.id }}</h4>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalTentativa">
          üßæ Registrar tentativa
        </button>
        <a href="{{ url_for('pesquisar_divisao') }}" class="btn btn-light btn-sm">‚¨ÖÔ∏è Voltar</a>
      </div>
    </div>

    <div class="card-body">
      <form method="POST" class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Fundo / Cole√ß√£o</label>
          <input type="text" name="fundo_colecao" class="form-control" value="{{ registro.fundo_colecao or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">T√≠tulo / Conte√∫do</label>
          <input type="text" name="titulo_conteudo" class="form-control" value="{{ registro.titulo_conteudo or '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">C√≥digo de Refer√™ncia</label>
          <input type="text" name="codigo_referencia" class="form-control" value="{{ registro.codigo_referencia or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Nota√ß√£o</label>
          <input type="text" name="notacao" class="form-control" value="{{ registro.notacao or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Localiza√ß√£o F√≠sica</label>
          <input type="text" name="localizacao_fisica" class="form-control" value="{{ registro.localizacao_fisica or '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Data do Registro</label>
          <input type="date" name="data_registro" class="form-control"
                 value="{{ registro.data_registro if registro.data_registro else '' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Data da Localiza√ß√£o</label>
          <input type="date" name="data_localizacao" class="form-control"
                 value="{{ registro.data_localizacao if registro.data_localizacao else '' }}">
        </div>

        <!-- ‚úÖ NOVO: Localizado? -->
        <div class="col-md-4">
          <label class="form-label fw-semibold">Localizado?</label>
          <select name="localizado" class="form-select">
            <option value="false" {% if not registro.localizado %}selected{% endif %}>N√£o</option>
            <option value="true" {% if registro.localizado %}selected{% endif %}>Sim</option>
          </select>
          <div class="form-text">Marque ‚ÄúSim‚Äù apenas quando o documento foi localizado.</div>
        </div>

        <div class="col-12">
          <label class="form-label fw-semibold">Observa√ß√µes</label>
          <textarea name="observacoes" class="form-control" rows="3">{{ registro.observacoes or '' }}</textarea>
        </div>

        <!-- ‚úÖ NOVO: Divis√£o como select -->
        <div class="col-12">
          <label class="form-label fw-semibold">Divis√£o</label>
          <select name="divisao" class="form-select" required>
            {% set div = (registro.divisao or '')|upper %}
            <option value="" disabled {% if not div %}selected{% endif %}>Selecione a divis√£o</option>
            <option value="DIJUD" {% if div == 'DIJUD' %}selected{% endif %}>DIJUD</option>
            <option value="DIPEX" {% if div == 'DIPEX' %}selected{% endif %}>DIPEX</option>
            <option value="DIPOP" {% if div == 'DIPOP' %}selected{% endif %}>DIPOP</option>
            <option value="DIDOC" {% if div == 'DIDOC' %}selected{% endif %}>DIDOC</option>
            <option value="DIDAS" {% if div == 'DIDAS' %}selected{% endif %}>DIDAS</option>
          </select>
          <div class="form-text">Isso evita erro de digita√ß√£o e garante consist√™ncia no banco.</div>
        </div>

        <div class="col-12 d-flex justify-content-between mt-3">
          <button type="submit" class="btn btn-success px-4">üíæ Salvar Altera√ß√µes</button>
          <a href="{{ url_for('pesquisar_divisao') }}" class="btn btn-secondary px-4">Cancelar</a>
        </div>
      </form>

            <!-- ‚úÖ Hist√≥rico de tentativas -->
      <hr class="my-4">
      <h5 class="fw-bold text-secondary mb-3">üìå Hist√≥rico de tentativas</h5>

      {% if tentativas and tentativas|length > 0 %}
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Data/Hora</th>
                <th>Status</th>
                <th>Usu√°rio</th>
                <th>Observa√ß√£o</th>
                <th class="text-center">Detalhes</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tentativas %}
              <tr>
                <!-- t[3] = criado_em -->
                <td>{{ t[3] | br_datetime }}</td>

                <!-- t[0] = status -->
                <td>
                  {% if t[0] == 'ENCONTRADO' %}
                    <span class="badge bg-success">Encontrado</span>
                  {% elif t[0] == 'NAO_ENCONTRADO' %}
                    <span class="badge bg-danger">N√£o encontrado</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Procurando</span>
                  {% endif %}
                </td>

                <!-- t[2] = criado_por -->
                <td>{{ t[2] }}</td>

                <!-- t[1] = observacao (resumo) -->
                <td>
                  {{ (t[1] or '')[:80] }}{% if t[1] and t[1]|length > 80 %}...{% endif %}
                </td>

                <!-- üîç Bot√£o Detalhes -->
                <td class="text-center">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#modalDetalheTentativa"
                    data-status="{{ t[0] }}"
                    data-observacao="{{ t[1] or '' }}"
                    data-usuario="{{ t[2] }}"
                    data-data="{{ t[3] | br_datetime }}"
                  >
                    üîé Detalhes
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-secondary mb-0">
          Nenhuma tentativa registrada ainda.
        </div>
      {% endif %}

      <!-- ‚úÖ MODAL Detalhe da tentativa -->
      <div class="modal fade" id="modalDetalheTentativa" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">üìÑ Detalhes da tentativa</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              <dl class="row mb-0">
                <dt class="col-sm-3">Data/Hora</dt>
                <dd class="col-sm-9" id="detTentativaData"></dd>

                <dt class="col-sm-3">Status</dt>
                <dd class="col-sm-9" id="detTentativaStatus"></dd>

                <dt class="col-sm-3">Usu√°rio</dt>
                <dd class="col-sm-9" id="detTentativaUsuario"></dd>

                <dt class="col-sm-3">Observa√ß√£o</dt>
                <dd class="col-sm-9">
                  <pre id="detTentativaObs" class="mb-0" style="white-space: pre-wrap;"></pre>
                </dd>
              </dl>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
          </div>
        </div>
      </div>


<!-- ‚úÖ MODAL Registrar tentativa -->
<div class="modal fade" id="modalTentativa" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered"><!-- üî• maior: modal-xl -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üßæ Registrar tentativa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <!-- üîπ Status em cima -->
          <div class="col-12">
            <label class="form-label fw-semibold">Status</label>
            <select id="tentativaStatus" class="form-select">
              <option value="PROCURANDO" selected>Procurando</option>
              <option value="NAO_ENCONTRADO">N√£o encontrado</option>
              <option value="ENCONTRADO">Encontrado</option>
            </select>
          </div>

          <!-- üîπ Observa√ß√£o logo abaixo, √°rea maior -->
          <div class="col-12">
            <label class="form-label fw-semibold">Observa√ß√£o (opcional)</label>
            <textarea
              id="tentativaObs"
              class="form-control"
              rows="5"
              maxlength="200"
              placeholder="Ex.: Procurei no arm√°rio X e caixa Y, sem sucesso."
            ></textarea>
            <div class="form-text">
              M√°ximo de 200 caracteres.
            </div>
          </div>

          <div class="col-12">
            <div id="tentativaFeedback"></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarTentativa()">
          Salvar tentativa
        </button>
      </div>
    </div>
  </div>
</div>


<script>
async function salvarTentativa() {
  const status = document.getElementById('tentativaStatus').value;
  const observacao = document.getElementById('tentativaObs').value;

  const feedback = document.getElementById('tentativaFeedback');
  feedback.innerHTML = "";

  try {
    const resp = await fetch("/registro/{{ registro.id }}/tentativa", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ status, observacao })
    });

    const data = await resp.json();

    feedback.innerHTML = `
      <div class="alert alert-${data.success ? 'success' : 'danger'} mb-0">
        ${data.message}
      </div>
    `;

    if (data.success) {
      setTimeout(() => window.location.reload(), 500);
    }
  } catch (e) {
    feedback.innerHTML = `
      <div class="alert alert-danger mb-0">
        Erro inesperado ao salvar tentativa.
      </div>
    `;
  }
}
</script>
<script>
  const modalDetalheTentativa = document.getElementById('modalDetalheTentativa');

  if (modalDetalheTentativa) {
    modalDetalheTentativa.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      if (!button) return;

      const status = button.getAttribute('data-status') || '';
      const observacao = button.getAttribute('data-observacao') || '';
      const usuario = button.getAttribute('data-usuario') || '';
      const data = button.getAttribute('data-data') || '';

      // elementos do modal
      const elData = modalDetalheTentativa.querySelector('#detTentativaData');
      const elStatus = modalDetalheTentativa.querySelector('#detTentativaStatus');
      const elUsuario = modalDetalheTentativa.querySelector('#detTentativaUsuario');
      const elObs = modalDetalheTentativa.querySelector('#detTentativaObs');

      if (elData) elData.textContent = data;
      if (elUsuario) elUsuario.textContent = usuario;

      if (elStatus) {
        let label = '';
        if (status === 'ENCONTRADO') label = 'Encontrado';
        else if (status === 'NAO_ENCONTRADO') label = 'N√£o encontrado';
        else label = 'Procurando';
        elStatus.textContent = label + ` (${status})`;
      }

      if (elObs) elObs.textContent = observacao || '‚Äî';
    });
  }
</script>

{% endblock %}
