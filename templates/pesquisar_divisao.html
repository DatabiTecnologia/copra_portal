{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm p-4">
    <h2 class="mb-3 text-primary">üîç Pesquisar por Divis√£o</h2>

    <!-- üîπ Selecionar divis√£o -->
    <form method="POST" class="row g-3 align-items-end mb-3">
      <div class="col-md-6">
        <label for="divisao" class="form-label fw-semibold">Selecione a divis√£o:</label>
        <select name="divisao" id="divisao" class="form-select" required>
          <option value="">-- Escolha --</option>
          {% for d in divisoes %}
            <option value="{{ d }}" {% if d == divisao_selecionada %}selected{% endif %}>
              {{ d }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          Pesquisar
        </button>
      </div>
    </form>

    {% if divisao_selecionada %}
      <hr>

      <h5 class="mt-3 text-secondary">
        üìÅ Divis√£o selecionada: <strong>{{ divisao_selecionada }}</strong>
      </h5>

      <p class="mb-2">
        <strong>Total de n√£o localizados:</strong>
        <span class="badge bg-danger">{{ total_nao_localizado }}</span>
      </p>

      <!-- üîπ Filtro por coluna -->
      <form method="POST" class="row g-3 align-items-end mb-4">
        <input type="hidden" name="divisao" value="{{ divisao_selecionada }}">

        <div class="col-md-4">
          <label for="coluna" class="form-label fw-semibold">Pesquisar em:</label>
          <select name="coluna" id="coluna" class="form-select">
            <option value="todas">Todas as colunas</option>
            <option value="fundo_colecao">Fundo / Cole√ß√£o</option>
            <option value="titulo_conteudo">T√≠tulo / Conte√∫do</option>
            <option value="codigo_referencia">C√≥digo de Refer√™ncia</option>
            <option value="notacao">Nota√ß√£o</option>
            <option value="localizacao_fisica">Localiza√ß√£o F√≠sica</option>
            <option value="observacoes">Observa√ß√µes</option>
          </select>
        </div>

        <div class="col-md-4">
          <label for="termo" class="form-label fw-semibold">Termo:</label>
          <input type="text" name="termo" id="termo"
                 class="form-control"
                 placeholder="Digite para filtrar">
        </div>

        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-success w-100">
            Filtrar
          </button>
        </div>
      </form>

      {% if mensagem %}
        <div class="alert alert-warning">
          {{ mensagem }}
        </div>
      {% else %}

        <!-- üîπ Exportar -->
        <form method="GET"
              action="{{ url_for('exportar_divisao', divisao=divisao_selecionada) }}"
              class="mb-3">
          <button type="submit" class="btn btn-outline-info">
            üì§ Exportar para Excel
          </button>
        </form>

        <!-- üîπ Tabela -->
        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
          <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>Fundo / Cole√ß√£o</th>
                <th>T√≠tulo / Conte√∫do</th>
                <th>C√≥digo Ref.</th>
                <th>Nota√ß√£o</th>
                <th>Localiza√ß√£o F√≠sica</th>
                <th>Data Registro</th>
                <th>Data Localiza√ß√£o</th>
                <th>Observa√ß√µes</th>
                <th>Divis√£o</th>
                <th>Localizado?</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for row in resultados %}
              <tr>
                <!-- ID com link -->
                <td>
                  <a href="{{ url_for('editar_registro', id=row[0]) }}"
                     class="fw-semibold text-decoration-none">
                    {{ row[0] }}
                  </a>
                </td>

                <td>{{ row[1] or '' }}</td>
                <td>{{ row[2] or '' }}</td>
                <td>{{ row[3] or '' }}</td>
                <td>{{ row[4] or '' }}</td>
                <td>{{ row[5] or '' }}</td>
                <td>{{ row[6] or '' }}</td>
                <td>{{ row[7] or '' }}</td>
                <td>{{ row[8] or '' }}</td>
                <td>{{ row[9] or '' }}</td>

                <!-- Localizado -->
                <td class="text-center">
                  {% if row[10] %}
                    <span class="badge bg-success">Encontrado</span>
                  {% else %}
                    <span class="badge bg-danger">N√£o encontrado</span>
                  {% endif %}
                </td>

                <!-- A√ß√µes -->
                <td class="text-center">
                  <a href="{{ url_for('editar_registro', id=row[0]) }}"
                     class="btn btn-sm btn-outline-warning">
                    ‚úèÔ∏è Editar
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}
