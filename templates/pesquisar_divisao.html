{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm p-4">
    <h2 class="mb-3 text-primary">üîç Pesquisar por Divis√£o</h2>

    <!-- üîπ Selecionar divis√£o -->
    <form method="POST" class="row g-3 align-items-end mb-3">
      <div class="col-md-6">
        <label for="divisao" class="form-label">Selecione a divis√£o:</label>
        <select name="divisao" id="divisao" class="form-select" required>
          <option value="">-- Escolha --</option>
          {% for d in divisoes %}
            <option value="{{ d }}" {% if d == divisao_selecionada %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Pesquisar</button>
      </div>
    </form>

    {% if divisao_selecionada %}
      <hr>
      <h4 class="mt-3 text-secondary">üìÅ Divis√£o selecionada: {{ divisao_selecionada }}</h4>
      <p><strong>Total de ‚Äún√£o localizado‚Äù:</strong> {{ total_nao_localizado }}</p>

      <!-- üîπ Filtro por coluna dentro da divis√£o -->
      <form method="POST" class="row g-3 align-items-end mb-4">
        <input type="hidden" name="divisao" value="{{ divisao_selecionada }}">
        <div class="col-md-4">
          <label for="coluna" class="form-label">Pesquisar em:</label>
          <select name="coluna" id="coluna" class="form-select" required>
            <option value="todas">Todas as colunas</option>
            <option value="fundo_colecao">Fundo / Cole√ß√£o</option>
            <option value="titulo_conteudo">T√≠tulo / Conte√∫do</option>
            <option value="codigo_referencia">C√≥digo de Refer√™ncia</option>
            <option value="notacao">Nota√ß√£o</option>
            <option value="localizacao_fisica">Localiza√ß√£o F√≠sica</option>
            <option value="data">Data</option>
            <option value="data_localizacao">Data da Localiza√ß√£o</option>
            <option value="observacoes">Observa√ß√µes</option>
            <option value="divisao">Divis√£o</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="termo" class="form-label">Termo de busca:</label>
          <input type="text" name="termo" id="termo" class="form-control" placeholder="Digite para filtrar..." required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-success w-100">Filtrar</button>
        </div>
      </form>

      {% if mensagem %}
        <div class="alert alert-warning">{{ mensagem }}</div>
      {% else %}
        <!-- üîπ Bot√£o de exporta√ß√£o -->
        <form method="GET" action="{{ url_for('exportar_divisao', divisao=divisao_selecionada) }}" class="mb-3">
          <button type="submit" class="btn btn-outline-info">
            üì§ Exportar resultados para Excel
          </button>
        </form>

        <!-- üîπ Tabela de resultados com rolagem -->
        <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
          <table class="table table-striped table-hover table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Fundo/Cole√ß√£o</th>
                <th>T√≠tulo / Conte√∫do</th>
                <th>C√≥digo de Refer√™ncia</th>
                <th>Nota√ß√£o</th>
                <th>Localiza√ß√£o F√≠sica</th>
                <th>Data Registro</th>
                <th>Data Localiza√ß√£o</th>
                <th>Observa√ß√µes</th>
                <th>Divis√£o</th>
                <th>A√ß√µes</th> <!-- üëà Nova coluna -->
              </tr>
            </thead>
            <tbody>
              {% for row in resultados %}
              <tr>
                {% for value in row %}
                  <td>{{ value if value else '' }}</td>
                {% endfor %}
                <td class="text-center">
                  <a href="{{ url_for('editar_registro', id=row[0]) }}" class="btn btn-sm btn-outline-warning">
                    ‚úèÔ∏è Editar
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}
