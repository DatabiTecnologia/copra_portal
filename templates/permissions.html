{% extends "base.html" %}
{% block content %}

<!-- LOADING -->
<div id="loadingOverlay"
     style="
       position: fixed;
       inset: 0;
       background: rgba(255,255,255,.85);
       display: flex;
       align-items: center;
       justify-content: center;
       z-index: 2000;
     ">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <div class="fw-semibold">Carregando permiss√µes‚Ä¶</div>
  </div>
</div>

<div class="container-fluid bg-white rounded shadow-sm p-4">

  <h2 class="fw-bold text-primary mb-3">Painel de Permiss√µes</h2>

  <!-- BUSCA -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input type="text"
             id="userSearch"
             class="form-control"
             placeholder="üîç Buscar usu√°rio..."
             oninput="applySearch()">
    </div>
  </div>

  <!-- TABELA -->
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Usu√°rio</th>

          <!-- P√ÅGINAS -->
          {% for page in pages %}
            <th class="text-center">
              {{ page_labels.get(page, page) }}
            </th>
          {% endfor %}

          <!-- DIVIS√ïES -->
          {% for div in divisoes %}
            <th class="text-center">{{ div }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody id="permissionsTable"></tbody>
    </table>
  </div>

  <!-- PAGINA√á√ÉO -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-outline-secondary btn-sm"
            onclick="changePage(-1)">
      ‚óÄ Anterior
    </button>

    <span id="pageInfo" class="fw-semibold"></span>

    <button class="btn btn-outline-secondary btn-sm"
            onclick="changePage(1)">
      Pr√≥xima ‚ñ∂
    </button>
  </div>

  <div id="feedback" class="mt-3"></div>
</div>

<script>
/* =========================
   DADOS
========================= */
const allUsers = {{ all_usernames|tojson }};
const pages = {{ pages|tojson }};
const pagePermissions = {{ page_permissions|tojson }};
const divisoes = {{ divisoes|tojson }};
const divisaoPermissions = {{ divisao_permissions|tojson }};

const PAGE_SIZE = 25;
let currentPage = 1;

/* =========================
   BUSCA
========================= */
function applySearch() {
  currentPage = 1;
  renderTable();
}

/* =========================
   PAGINA√á√ÉO
========================= */
function getPagedUsers(filter = "") {
  const filtered = allUsers.filter(u =>
    u.toLowerCase().includes(filter)
  );

  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));

  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;

  return {
    users: filtered.slice(start, end),
    totalPages
  };
}

function changePage(delta) {
  currentPage += delta;
  if (currentPage < 1) currentPage = 1;
  renderTable();
}

/* =========================
   RENDER
========================= */
function renderTable() {
  const filter = document.getElementById('userSearch').value.toLowerCase();
  const tbody = document.getElementById("permissionsTable");
  tbody.innerHTML = "";

  const { users, totalPages } = getPagedUsers(filter);

  users.forEach(username => {

    let row = `<tr><td class="fw-semibold">${username}</td>`;

    /* P√ÅGINAS */
    pages.forEach(page => {
      const checked = pagePermissions[page]?.includes(username) ? "checked" : "";
      row += `
        <td class="text-center">
          <input type="checkbox"
                 ${checked}
                 onchange="togglePage('${username}','${page}', this.checked)">
        </td>
      `;
    });

    /* DIVIS√ïES */
    divisoes.forEach(div => {
      const key = `${username}::${div}`;
      const checked = divisaoPermissions.includes(key) ? "checked" : "";
      row += `
        <td class="text-center">
          <input type="checkbox"
                 ${checked}
                 onchange="toggleDivisao('${username}','${div}', this.checked)">
        </td>
      `;
    });

    row += "</tr>";
    tbody.innerHTML += row;
  });

  document.getElementById('pageInfo').innerText =
    `P√°gina ${currentPage} de ${totalPages}`;

  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.remove();
}

/* =========================
   A√á√ïES
========================= */
function togglePage(username, page, checked) {
  fetch('/permissions/page/action', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username,
      page,
      action: checked ? 'GRANT' : 'REMOVE'
    })
  })
  .then(r => r.json())
  .then(showFeedback);
}

function toggleDivisao(username, divisao, checked) {
  fetch('/permissions/divisao/action', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username,
      divisao,
      action: checked ? 'GRANT' : 'REMOVE'
    })
  })
  .then(r => r.json())
  .then(showFeedback);
}

/* =========================
   FEEDBACK
========================= */
function showFeedback(res){
  document.getElementById('feedback').innerHTML = `
    <div class="alert alert-${res.success ? 'success':'danger'}">
      ${res.message}
    </div>
  `;
}

/* =========================
   INIT
========================= */
renderTable();
</script>

{% endblock %}
