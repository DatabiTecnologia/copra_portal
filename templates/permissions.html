{% extends "base.html" %}
{% block content %}

<!-- LOADING -->
<div id="loadingOverlay"
     style="
       position: fixed;
       inset: 0;
       background: rgba(255,255,255,.85);
       display: flex;
       align-items: center;
       justify-content: center;
       z-index: 2000;
     ">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <div class="fw-semibold">Carregando permiss√µes‚Ä¶</div>
  </div>
</div>

<div class="container-fluid bg-white rounded shadow-sm p-4">

  <h2 class="fw-bold text-primary mb-3">Painel de Permiss√µes</h2>

  <!-- üîç FILTROS -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Buscar usu√°rio</label>
      <input type="text"
             id="userSearch"
             class="form-control"
             placeholder="üîç Buscar usu√°rio..."
             oninput="applySearch()">
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Filtrar por department</label>
      <input type="text"
             id="deptSearch"
             class="form-control"
             list="deptOptions"
             placeholder="Digite parte do department (ex: COPRA)"
             oninput="applySearch()">
      <datalist id="deptOptions">
        {% for dep in departments %}
          <option value="{{ dep }}">
        {% endfor %}
      </datalist>
      <div class="form-text">
        O filtro considera qualquer parte do texto. Ex.: "COPRA" encontra "COPRA", "COPRA-GABIN", "GABIN/COPRA"‚Ä¶
      </div>
    </div>

    <div class="col-md-2 d-flex align-items-end">
      <button type="button"
              class="btn btn-outline-secondary w-100"
              onclick="clearDeptFilter()">
        Limpar filtros
      </button>
    </div>
  </div>

  <!-- üîÅ A√á√ÉO EM MASSA POR DIVIS√ÉO -->
  <div class="border rounded p-3 mb-3">
    <h5 class="fw-semibold mb-2">A√ß√£o em massa por divis√£o (para usu√°rios filtrados)</h5>
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Divis√£o</label>
        <select id="bulkDivisao" class="form-select">
          <option value="">Selecione a divis√£o...</option>
          {% for div in divisoes %}
            <option value="{{ div }}">{{ div }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <button type="button"
                class="btn btn-sm btn-outline-primary me-2"
                onclick="aplicarDivisaoEmMassa(true)">
          ‚úÖ Conceder divis√£o para todos filtrados
        </button>
        <button type="button"
                class="btn btn-sm btn-outline-danger"
                onclick="aplicarDivisaoEmMassa(false)">
          ‚ùå Remover divis√£o de todos filtrados
        </button>
      </div>
      <div class="col-12">
        <small class="text-muted">
          A a√ß√£o √© aplicada a todos os usu√°rios exibidos, considerando os filtros de usu√°rio e department.
        </small>
      </div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Usu√°rio</th>
          <!-- Se quiser mostrar o department, descomenta abaixo -->
          <!-- <th>Department</th> -->

          <!-- P√ÅGINAS -->
          {% for page in pages %}
            <th class="text-center">
              {{ page_labels.get(page, page) }}
            </th>
          {% endfor %}

          <!-- DIVIS√ïES -->
          {% for div in divisoes %}
            <th class="text-center">{{ div }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody id="permissionsTable"></tbody>
    </table>
  </div>

  <!-- PAGINA√á√ÉO -->
  <div class="d-flex justify-content-between align-items-center mt-3">
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary btn-sm"
            onclick="changePage(-1)">
      ‚óÄ Anterior
    </button>

    <button class="btn btn-outline-secondary btn-sm"
            onclick="changePage(1)">
      Pr√≥xima ‚ñ∂
    </button>
  </div>

  <span id="pageInfo" class="fw-semibold"></span>

  <!-- ‚úÖ Novo: bot√£o para liberar todos os acessos (p√°gina atual) -->
  <button class="btn btn-success btn-sm"
          onclick="bulkGrantAllVisible()">
    üîì Liberar TODOS os acessos (usu√°rios desta p√°gina)
  </button>
</div>

<div id="feedback" class="mt-3"></div>


<script>
/* =========================
   DADOS
========================= */
const allUsers = {{ all_usernames|tojson }};
const pages = {{ pages|tojson }};
const pagePermissions = {{ page_permissions|tojson }};
const divisoes = {{ divisoes|tojson }};
const divisaoPermissions = {{ divisao_permissions|tojson }};
const userDepartments = {{ user_departments|tojson }};  // {username: department}

const PAGE_SIZE = 25;
let currentPage = 1;

/* =========================
   FILTROS
========================= */
function applySearch() {
  currentPage = 1;
  renderTable();
}

function clearDeptFilter() {
  document.getElementById('userSearch').value = '';
  document.getElementById('deptSearch').value = '';
  currentPage = 1;
  renderTable();
}

// retorna TODOS os usu√°rios ap√≥s aplicar os filtros de texto e department
function getFilteredUsers() {
  const nameFilter = document.getElementById('userSearch').value.toLowerCase();
  const deptFilter = document.getElementById('deptSearch').value.toLowerCase();

  return allUsers.filter(u => {
    const nameMatch = !nameFilter || u.toLowerCase().includes(nameFilter);

    const dept = (userDepartments[u] || '').toLowerCase();
    const deptMatch = !deptFilter || dept.includes(deptFilter);

    return nameMatch && deptMatch;
  });
}

/* =========================
   PAGINA√á√ÉO
========================= */
function getPagedUsers() {
  const filtered = getFilteredUsers();

  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;

  return {
    users: filtered.slice(start, end),
    totalPages,
    totalFiltered: filtered.length
  };
}

function changePage(delta) {
  currentPage += delta;
  if (currentPage < 1) currentPage = 1;
  renderTable();
}

/* =========================
   RENDER
========================= */
function renderTable() {
  const tbody = document.getElementById("permissionsTable");
  tbody.innerHTML = "";

  const { users, totalPages, totalFiltered } = getPagedUsers();

  users.forEach(username => {
    let row = `<tr data-username="${username}"><td class="fw-semibold">${username}</td>`;


    /* Se quiser exibir o department, descomenta:
    const dept = userDepartments[username] || '';
    row += `<td>${dept}</td>`;
    */

    /* P√ÅGINAS */
    pages.forEach(page => {
      const checked = pagePermissions[page]?.includes(username) ? "checked" : "";
      row += `
        <td class="text-center">
          <input type="checkbox"
                 ${checked}
                 onchange="togglePage('${username}','${page}', this.checked)">
        </td>
      `;
    });

    /* DIVIS√ïES */
    divisoes.forEach(div => {
      const key = `${username}::${div}`;
      const checked = divisaoPermissions.includes(key) ? "checked" : "";
      row += `
        <td class="text-center">
          <input type="checkbox"
                 ${checked}
                 onchange="toggleDivisao('${username}','${div}', this.checked)">
        </td>
      `;
    });

    row += "</tr>";
    tbody.innerHTML += row;
  });

  document.getElementById('pageInfo').innerText =
    `P√°gina ${currentPage} de ${totalPages} ‚Äî ${totalFiltered} usu√°rio(s) filtrado(s)`;

  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.remove();
}

/* =========================
   A√á√ïES INDIVIDUAIS
========================= */
function togglePage(username, page, checked) {
  fetch('/permissions/page/action', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username,
      page,
      action: checked ? 'GRANT' : 'REMOVE'
    })
  })
  .then(r => r.json())
  .then(showFeedback);
}

function toggleDivisao(username, divisao, checked) {
  fetch('/permissions/divisao/action', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      username,
      divisao,
      action: checked ? 'GRANT' : 'REMOVE'
    })
  })
  .then(r => r.json())
  .then(showFeedback);
}

/* =========================
   A√á√ÉO EM MASSA - DIVIS√ÉO
========================= */
function aplicarDivisaoEmMassa(grant) {
  const divisao = document.getElementById('bulkDivisao').value;
  if (!divisao) {
    showFeedback({success: false, message: 'Selecione uma divis√£o para aplicar em massa.'});
    return;
  }

  const usuarios = getFilteredUsers();
  if (usuarios.length === 0) {
    showFeedback({success: false, message: 'Nenhum usu√°rio filtrado para aplicar a a√ß√£o.'});
    return;
  }

  if (!confirm(`Aplicar divis√£o "${divisao}" para ${usuarios.length} usu√°rio(s) filtrado(s)?`)) {
    return;
  }

  const promises = usuarios.map(username =>
    fetch('/permissions/divisao/action', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        username,
        divisao,
        action: grant ? 'GRANT' : 'REMOVE'
      })
    }).then(r => r.json())
  );

  Promise.all(promises)
    .then(results => {
      const anyError = results.some(r => !r.success);
      showFeedback({
        success: !anyError,
        message: anyError
          ? 'A√ß√£o em massa conclu√≠da com alguns erros. Verifique os logs.'
          : `A√ß√£o em massa conclu√≠da para ${usuarios.length} usu√°rio(s).`
      });
      // Ideal: recarregar permiss√µes do backend; por enquanto, recarrega a p√°gina
      setTimeout(() => window.location.reload(), 800);
    })
    .catch(() => {
      showFeedback({success: false, message: 'Erro ao executar a√ß√£o em massa.'});
    });
}

/* =========================
   FEEDBACK
========================= */
function showFeedback(res){
  document.getElementById('feedback').innerHTML = `
    <div class="alert alert-${res.success ? 'success':'danger'} mt-2 mb-0">
      ${res.message}
    </div>
  `;
}
/* =========================
   A√á√ÉO EM MASSA - LIBERAR TODOS OS ACESSOS (P√ÅGINA ATUAL)
========================= */
function bulkGrantAllVisible() {
  const tbody = document.getElementById("permissionsTable");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const usernames = rows
    .map(tr => tr.getAttribute("data-username"))
    .filter(Boolean);

  if (!usernames.length) {
    showFeedback({success: false, message: "Nenhum usu√°rio na p√°gina atual."});
    return;
  }

  if (!confirm(`Liberar TODOS os acessos (p√°ginas + divis√µes) para ${usernames.length} usu√°rio(s) da p√°gina atual?`)) {
    return;
  }

  fetch('/permissions/bulk/grant_all', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ usernames })
  })
  .then(r => r.json())
  .then(res => {
    showFeedback(res);

    // opcional: recarregar tabela para refletir as checkboxes
    if (res.success) {
      // recarrega do servidor ou s√≥ re-renderiza local?
      // aqui vamos s√≥ re-renderizar, as checkboxes j√° estavam certas na tela,
      // mas se quiser garantir, chama renderTable():
      // renderTable();
    }
  })
  .catch(err => {
    console.error(err);
    showFeedback({success: false, message: "Erro ao comunicar com o servidor."});
  });
}


/* =========================
   INIT
========================= */
renderTable();
</script>

{% endblock %}
