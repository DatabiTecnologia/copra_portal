{% extends "base.html" %}
{% block content %}
  <div class="bg-white rounded shadow-sm mb-4 p-4">
    <h2 class="fw-bold text-primary mb-4" style="letter-spacing:1px;">
      Inserir registro
    </h2>

    <!-- üîπ Se√ß√£o 1 - Inser√ß√£o manual -->
    <h5 class="fw-bold text-secondary mb-3">Inser√ß√£o Manual</h5>

    <form method="POST" class="d-flex flex-column gap-3 mb-5" id="form-inserir-manual">

      <div class="row">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Fundo / Cole√ß√£o</label>
          <input
            type="text"
            name="fundo_colecao"
            class="form-control"
            placeholder="Ex: Pretoria C√≠vel do Rio de Janeiro, 6"
          >
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">T√≠tulo / Conte√∫do *</label>
          <input
            type="text"
            name="titulo_conteudo"
            class="form-control"
            placeholder="Ex: Registro Civil - 6S"
            required
          >
        </div>
      </div>

      <div class="row">
        <!-- C√ìDIGO DE REFER√äNCIA -->
        <div class="col-md-4">
          <label class="form-label fw-semibold">
            C√≥digo de Refer√™ncia
            <span class="text-muted" style="font-size: 0.8rem;">
              (preencha <strong>apenas um</strong>: C√≥digo <u>ou</u> Nota√ß√£o)
            </span>
          </label>
          <input
            type="text"
            name="codigo_referencia"
            class="form-control"
            placeholder="Ex: BR_RJANRIO_R0_0001"
            value="{{ codigo_prefill or '' }}"
          >
        </div>

        <!-- BLOCO DE NOTA√á√ÉO ESTRUTURADA -->
        <div class="col-md-8">
          <label class="form-label fw-semibold d-block">
            Nota√ß√£o (estruturada)
            <span class="text-muted" style="font-size: 0.8rem;">
              (ser√° enviada como uma frase: C√≥digo, N√∫mero do documento, Caixa, Ma√ßo)
            </span>
          </label>

          <div class="row g-2">
            <div class="col-md-3">
              <input
                type="text"
                id="nota_codigo"
                class="form-control"
                placeholder="C√≥digo"
              >
            </div>
            <div class="col-md-3">
              <input
                type="text"
                id="nota_numero"
                class="form-control"
                placeholder="N√∫mero do documento"
              >
            </div>
            <div class="col-md-3">
              <input
                type="text"
                id="nota_caixa"
                class="form-control"
                placeholder="Caixa"
              >
            </div>
            <div class="col-md-3">
              <input
                type="text"
                id="nota_maco"
                class="form-control"
                placeholder="Ma√ßo"
              >
            </div>
          </div>

          <!-- Campo oculto que realmente vai para o backend -->
          <input type="hidden" name="notacao" id="hidden_notacao" value="{{ notacao_prefill or '' }}">

          <div class="form-text">
            Preencha os campos acima para gerar a nota√ß√£o automaticamente.  
            Exemplo final: <code>C√ìDIGO 123, DOC 5, CAIXA 2, MA√áO 1</code>
          </div>
        </div>
      </div>

      <div class="row mt-2">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Localiza√ß√£o F√≠sica</label>
          <input
            type="text"
            name="localizacao_fisica"
            class="form-control"
            placeholder="Ex: Estante 4, Prateleira 2"
          >
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Data do Registro</label>
          <input type="date" name="data_registro" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Data da Localiza√ß√£o</label>
          <input type="date" name="data_localizacao" class="form-control">
        </div>
      </div>

      <div class="row mt-2">
        <!-- ‚úÖ Localizado? -->
        <div class="col-md-4">
          <label class="form-label fw-semibold">Localizado?</label>
          <select name="localizado" class="form-select">
            <option value="false" selected>N√£o</option>
            <option value="true">Sim</option>
          </select>
          <div class="form-text">Use ‚ÄúSim‚Äù apenas quando o documento foi localizado.</div>
        </div>
      </div>

      <div>
        <label class="form-label fw-semibold">Observa√ß√µes</label>
        <textarea
          name="observacoes"
          class="form-control"
          rows="3"
          placeholder="Digite observa√ß√µes adicionais..."
        ></textarea>
      </div>

      <div>
        <label class="form-label fw-semibold">Divis√£o</label>
        <select name="divisao" class="form-control" required>
          <option value="" disabled selected>Selecione a divis√£o</option>
          <option value="DIJUD">DIJUD</option>
          <option value="DIPEX">DIPEX</option>
          <option value="DIDOP">DIDOP</option>
          <option value="DIDOC">DIDOC</option>
          <option value="DIDAS">DIDAS</option>
        </select>
      </div>

      <!-- ‚úÖ Nome do submit para ficar expl√≠cito -->
      <button
        type="submit"
        name="inserir_manual"
        class="btn btn-primary align-self-start mt-3"
      >
        Inserir registro
      </button>
    </form>

    <!-- üîπ Se√ß√£o 2 - Upload de planilha -->
    <div class="border-top pt-4">
      <h5 class="fw-bold text-secondary mb-3">Inser√ß√£o via Planilha</h5>
      <p class="text-muted">
        Fa√ßa o upload de uma planilha Excel (.xlsx) contendo os registros a serem inseridos.
        Certifique-se de que a planilha siga o modelo padr√£o para evitar erros na inser√ß√£o.
      </p>

      <!-- Download da planilha padr√£o -->
      <div class="mb-3">
        <a href="{{ url_for('download_modelo') }}" class="btn btn-outline-success btn-sm">
          üì• Baixar planilha modelo (.xlsx)
        </a>
      </div>

      <!-- Upload de arquivo -->
      <form method="POST" enctype="multipart/form-data" class="d-flex flex-column gap-3">
        <input type="file" name="file" accept=".xlsx,.xls" class="form-control" required>
        <button type="submit" name="upload_planilha" class="btn btn-primary align-self-start mt-2">
          üöÄ Enviar Planilha e Inserir registro
        </button>
      </form>
    </div>

    <!-- üîπ Outras a√ß√µes -->
    <div class="border-top pt-4 mt-4">
      <h5 class="fw-bold text-secondary mb-3">Outras a√ß√µes</h5>

      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('home') }}" class="btn btn-outline-primary">Voltar para Home</a>

        <!-- ‚úÖ Novo bot√£o de pesquisa por divis√£o -->
        <a href="{{ url_for('pesquisar_divisao') }}" class="btn btn-outline-success">
          üîç Pesquisar por Divis√£o
        </a>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Script: foco + montagem da nota√ß√£o + valida√ß√£o XOR -->
  <script>
    (function () {
      const codigoPrefill = "{{ (codigo_prefill or '')|e }}";
      const notacaoPrefill = "{{ (notacao_prefill or '')|e }}";

      const campoCodigo = document.querySelector('input[name="codigo_referencia"]');
      const hiddenNotacao = document.getElementById('hidden_notacao');

      const notaCodigo  = document.getElementById('nota_codigo');
      const notaNumero  = document.getElementById('nota_numero');
      const notaCaixa   = document.getElementById('nota_caixa');
      const notaMaco    = document.getElementById('nota_maco');

      // üîπ Foco autom√°tico
      if (codigoPrefill && campoCodigo) {
        campoCodigo.focus();
      } else if (notacaoPrefill) {
        // se vier nota√ß√£o prefill, tentamos jogar no hidden e campo de c√≥digo da nota√ß√£o
        if (hiddenNotacao) hiddenNotacao.value = notacaoPrefill;
      }

      // üîπ Monta a nota√ß√£o a partir dos 4 campos
      function montarNotacao() {
        const partes = [];

        const c  = (notaCodigo.value || "").trim();
        const n  = (notaNumero.value || "").trim();
        const cx = (notaCaixa.value || "").trim();
        const m  = (notaMaco.value || "").trim();

        if (c)  partes.push(c);
        if (n)  partes.push(n);
        if (cx) partes.push(cx);
        if (m)  partes.push(m);

        const notacaoFinal = partes.join(', ');
        if (hiddenNotacao) hiddenNotacao.value = notacaoFinal;

        return notacaoFinal;
      }

      // üîπ Valida√ß√£o: exatamente um dos campos (C√≥digo OU Nota√ß√£o estruturada)
      const form = document.getElementById('form-inserir-manual');
      if (form) {
        form.addEventListener('submit', function (e) {
          const cod = (campoCodigo.value || '').trim();
          const notacaoFinal = montarNotacao();

          const temCodigo = !!cod;
          const temNotacao = !!notacaoFinal;

          if (!temCodigo && !temNotacao) {
            e.preventDefault();
            alert('Preencha pelo menos um: C√≥digo de Refer√™ncia OU Nota√ß√£o (estrutura: C√≥digo, N√∫mero, Caixa, Ma√ßo).');
            return;
          }

          if (temCodigo && temNotacao) {
            e.preventDefault();
            alert('Preencha apenas um dos campos: C√≥digo de Refer√™ncia OU Nota√ß√£o estruturada (n√£o os dois).');
            return;
          }
        });
      }
    })();
  </script>
{% endblock %}
