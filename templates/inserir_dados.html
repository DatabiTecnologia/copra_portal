{% extends "base.html" %}
{% block content %}
  <div class="bg-white rounded shadow-sm mb-4 p-4">
    <h2 class="fw-bold text-primary mb-4" style="letter-spacing:1px;">
      Inserir registro
    </h2>

    <!-- üîπ Se√ß√£o 1 - Inser√ß√£o manual -->
    <h5 class="fw-bold text-secondary mb-3">Inser√ß√£o Manual</h5>

    <form method="POST" class="d-flex flex-column gap-3 mb-5" id="form-inserir-manual">

      <div class="row">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Fundo / Cole√ß√£o</label>
          <input
            type="text"
            name="fundo_colecao"
            class="form-control"
            placeholder="Ex: Pretoria C√≠vel do Rio de Janeiro, 6"
          >
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">T√≠tulo / Conte√∫do *</label>
          <input
            type="text"
            name="titulo_conteudo"
            class="form-control"
            placeholder="Ex: Registro Civil - 6S"
            required
          >
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <label class="form-label fw-semibold">
            C√≥digo de Refer√™ncia
            <span class="text-muted" style="font-size: 0.8rem;">
              (preencha <strong>apenas um</strong>: C√≥digo <u>ou</u> Nota√ß√£o)
            </span>
          </label>
          <input
            type="text"
            name="codigo_referencia"
            class="form-control"
            placeholder="Ex: 12345"
            value="{{ codigo_prefill or '' }}"
          >
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Nota√ß√£o</label>
          <input
            type="text"
            name="notacao"
            class="form-control"
            placeholder="Ex: Livro 2-A"
            value="{{ notacao_prefill or '' }}"
          >
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Localiza√ß√£o F√≠sica</label>
          <input
            type="text"
            name="localizacao_fisica"
            class="form-control"
            placeholder="Ex: Estante 4, Prateleira 2"
          >
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Data do Registro</label>
          <input type="date" name="data_registro" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Data da Localiza√ß√£o</label>
          <input type="date" name="data_localizacao" class="form-control">
        </div>

        <!-- ‚úÖ NOVO: Localizado? -->
        <div class="col-md-4">
          <label class="form-label fw-semibold">Localizado?</label>
          <select name="localizado" class="form-select">
            <option value="false" selected>N√£o</option>
            <option value="true">Sim</option>
          </select>
          <div class="form-text">Use ‚ÄúSim‚Äù apenas quando o documento foi localizado.</div>
        </div>
      </div>

      <div>
        <label class="form-label fw-semibold">Observa√ß√µes</label>
        <textarea
          name="observacoes"
          class="form-control"
          rows="3"
          placeholder="Digite observa√ß√µes adicionais..."
        ></textarea>
      </div>

      <div>
        <label class="form-label fw-semibold">Divis√£o</label>
        <select name="divisao" class="form-control" required>
          <option value="" disabled selected>Selecione a divis√£o</option>
          <option value="DIJUD">DIJUD</option>
          <option value="DIPEX">DIPEX</option>
          <option value="DIPOP">DIPOP</option>
          <option value="DIDOC">DIDOC</option>
          <option value="DIDAS">DIDAS</option>
        </select>
      </div>

      <!-- ‚úÖ Nome do submit para ficar expl√≠cito -->
      <button
        type="submit"
        name="inserir_manual"
        class="btn btn-primary align-self-start mt-3"
      >
        Inserir registro
      </button>
    </form>

    <!-- üîπ Se√ß√£o 2 - Upload de planilha -->
    <div class="border-top pt-4">
      <h5 class="fw-bold text-secondary mb-3">Inser√ß√£o via Planilha</h5>
      <p class="text-muted">
        Fa√ßa o upload de uma planilha Excel (.xlsx) contendo os registros a serem inseridos.
        Certifique-se de que a planilha siga o modelo padr√£o para evitar erros na inser√ß√£o.
      </p>

      <!-- Download da planilha padr√£o -->
      <div class="mb-3">
        <a href="{{ url_for('download_modelo') }}" class="btn btn-outline-success btn-sm">
          üì• Baixar planilha modelo (.xlsx)
        </a>
      </div>

      <!-- Upload de arquivo -->
      <form method="POST" enctype="multipart/form-data" class="d-flex flex-column gap-3">
        <input type="file" name="file" accept=".xlsx,.xls" class="form-control" required>
        <button type="submit" name="upload_planilha" class="btn btn-primary align-self-start mt-2">
          üöÄ Enviar Planilha e Inserir registro
        </button>
      </form>
    </div>

    <!-- üîπ Outras a√ß√µes -->
    <div class="border-top pt-4 mt-4">
      <h5 class="fw-bold text-secondary mb-3">Outras a√ß√µes</h5>

      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('home') }}" class="btn btn-outline-primary">Voltar para Home</a>

        <!-- ‚úÖ Novo bot√£o de pesquisa por divis√£o -->
        <a href="{{ url_for('pesquisar_divisao') }}" class="btn btn-outline-success">
          üîç Pesquisar por Divis√£o
        </a>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Script: foco + valida√ß√£o XOR dos campos -->
  <script>
    (function () {
      const codigo = "{{ (codigo_prefill or '')|e }}";
      const notacao = "{{ (notacao_prefill or '')|e }}";

      // Foco autom√°tico
      if (codigo) {
        const el = document.querySelector('input[name="codigo_referencia"]');
        if (el) el.focus();
      } else if (notacao) {
        const el = document.querySelector('input[name="notacao"]');
        if (el) el.focus();
      }

      // Valida√ß√£o: exatamente um dos campos (c√≥digo OU nota√ß√£o)
      const form = document.getElementById('form-inserir-manual');
      if (form) {
        form.addEventListener('submit', function (e) {
          const cod = form.querySelector('input[name="codigo_referencia"]').value.trim();
          const nota = form.querySelector('input[name="notacao"]').value.trim();

          if (!cod && !nota) {
            e.preventDefault();
            alert('Preencha pelo menos um dos campos: C√≥digo de Refer√™ncia OU Nota√ß√£o.');
            return;
          }

          if (cod && nota) {
            e.preventDefault();
            alert('Preencha apenas um dos campos: C√≥digo de Refer√™ncia OU Nota√ß√£o (n√£o os dois).');
            return;
          }
        });
      }
    })();
  </script>
{% endblock %}
